// Prisma Schema for Subscription Tracking App
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      String    @id @default(uuid()) @db.Uuid
  email                   String    @unique
  passwordHash            String    @map("password_hash")
  firstName               String    @map("first_name")
  lastName                String    @map("last_name")
  avatarUrl               String?   @map("avatar_url")
  timezone                String    @default("UTC")
  currency                String    @default("USD") @db.VarChar(3)
  dateFormat              String    @default("MM/DD/YYYY") @map("date_format")
  notificationPreferences Json      @default("{\"email\": true, \"push\": true, \"sms\": false}") @map("notification_preferences")
  monthlyBudget           Decimal   @default(0.00) @map("monthly_budget") @db.Decimal(10, 2)
  isActive                Boolean   @default(true) @map("is_active")
  emailVerified           Boolean   @default(false) @map("email_verified")
  createdAt               DateTime  @default(now()) @map("created_at")
  updatedAt               DateTime  @updatedAt @map("updated_at")

  // Relations
  categories        Category[]
  subscriptions     Subscription[]
  payments          Payment[]
  budgetAllocations BudgetAllocation[]
  notifications     Notification[]
  sessions          UserSession[]
  auditLogs         AuditLog[]

  @@map("users")
}

model Category {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  name        String
  description String?
  color       String   @default("#3B82F6") @db.VarChar(7)
  icon        String   @default("folder")
  budgetLimit Decimal  @default(0.00) @map("budget_limit") @db.Decimal(10, 2)
  isDefault   Boolean  @default(false) @map("is_default")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscriptions     Subscription[]
  budgetAllocations BudgetAllocation[]

  @@unique([userId, name])
  @@map("categories")
}

model Subscription {
  id               String    @id @default(uuid()) @db.Uuid
  userId           String    @map("user_id") @db.Uuid
  categoryId       String?   @map("category_id") @db.Uuid
  name             String
  description      String?
  provider         String
  websiteUrl       String?   @map("website_url")
  logoUrl          String?   @map("logo_url")
  cost             Decimal   @db.Decimal(10, 2)
  currency         String    @default("USD") @db.VarChar(3)
  billingCycle     BillingCycle @map("billing_cycle")
  billingCycleCount Int      @default(1) @map("billing_cycle_count")
  nextBillingDate  DateTime  @map("next_billing_date") @db.Date
  startDate        DateTime  @map("start_date") @db.Date
  endDate          DateTime? @map("end_date") @db.Date
  autoRenewal      Boolean   @default(true) @map("auto_renewal")
  reminderDays     Int       @default(3) @map("reminder_days")
  paymentMethod    String?   @map("payment_method")
  accountEmail     String?   @map("account_email")
  notes            String?
  tags             String[]
  isActive         Boolean   @default(true) @map("is_active")
  isPaused         Boolean   @default(false) @map("is_paused")
  pauseStartDate   DateTime? @map("pause_start_date") @db.Date
  pauseEndDate     DateTime? @map("pause_end_date") @db.Date
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  // Relations
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  category      Category?      @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  payments      Payment[]
  notifications Notification[]

  @@map("subscriptions")
}

model Payment {
  id             String        @id @default(uuid()) @db.Uuid
  subscriptionId String        @map("subscription_id") @db.Uuid
  userId         String        @map("user_id") @db.Uuid
  amount         Decimal       @db.Decimal(10, 2)
  currency       String        @default("USD") @db.VarChar(3)
  paymentDate    DateTime      @map("payment_date") @db.Date
  paymentMethod  String?       @map("payment_method")
  transactionId  String?       @map("transaction_id")
  status         PaymentStatus @default(completed)
  notes          String?
  receiptUrl     String?       @map("receipt_url")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  // Relations
  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("payments")
}

model BudgetAllocation {
  id              String     @id @default(uuid()) @db.Uuid
  userId          String     @map("user_id") @db.Uuid
  categoryId      String?    @map("category_id") @db.Uuid
  name            String
  budgetType      BudgetType @default(monthly) @map("budget_type")
  allocatedAmount Decimal    @map("allocated_amount") @db.Decimal(10, 2)
  spentAmount     Decimal    @default(0.00) @map("spent_amount") @db.Decimal(10, 2)
  currency        String     @default("USD") @db.VarChar(3)
  startDate       DateTime   @map("start_date") @db.Date
  endDate         DateTime   @map("end_date") @db.Date
  autoRollover    Boolean    @default(false) @map("auto_rollover")
  alertThreshold  Decimal    @default(80.00) @map("alert_threshold") @db.Decimal(5, 2)
  isActive        Boolean    @default(true) @map("is_active")
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")

  // Relations
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  category      Category?      @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  notifications Notification[]

  @@map("budget_allocations")
}

model Notification {
  id                 String            @id @default(uuid()) @db.Uuid
  userId             String            @map("user_id") @db.Uuid
  subscriptionId     String?           @map("subscription_id") @db.Uuid
  budgetAllocationId String?           @map("budget_allocation_id") @db.Uuid
  type               NotificationType
  title              String
  message            String
  priority           Priority          @default(medium)
  scheduledFor       DateTime?         @map("scheduled_for")
  sentAt             DateTime?         @map("sent_at")
  isRead             Boolean           @default(false) @map("is_read")
  deliveryMethod     DeliveryMethod    @default(in_app) @map("delivery_method")
  metadata           Json?
  createdAt          DateTime          @default(now()) @map("created_at")
  updatedAt          DateTime          @updatedAt @map("updated_at")

  // Relations
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscription     Subscription?     @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  budgetAllocation BudgetAllocation? @relation(fields: [budgetAllocationId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model UserSession {
  id           String    @id @default(uuid()) @db.Uuid
  userId       String    @map("user_id") @db.Uuid
  sessionToken String    @unique @map("session_token")
  expiresAt    DateTime  @map("expires_at")
  ipAddress    String?   @map("ip_address")
  userAgent    String?   @map("user_agent")
  isActive     Boolean   @default(true) @map("is_active")
  createdAt    DateTime  @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_sessions")
}

model AuditLog {
  id         String    @id @default(uuid()) @db.Uuid
  userId     String?   @map("user_id") @db.Uuid
  tableName  String    @map("table_name")
  recordId   String    @map("record_id") @db.Uuid
  action     AuditAction
  oldValues  Json?     @map("old_values")
  newValues  Json?     @map("new_values")
  ipAddress  String?   @map("ip_address")
  userAgent  String?   @map("user_agent")
  createdAt  DateTime  @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("audit_logs")
}

// Enums
enum BillingCycle {
  weekly
  monthly
  quarterly
  semi_annually @map("semi-annually")
  annually
}

enum PaymentStatus {
  pending
  completed
  failed
  refunded
  disputed
}

enum BudgetType {
  weekly
  monthly
  quarterly
  annually
}

enum NotificationType {
  payment_due
  payment_failed
  subscription_expiring
  budget_exceeded
  budget_warning
  renewal_reminder
  trial_ending
}

enum Priority {
  low
  medium
  high
  urgent
}

enum DeliveryMethod {
  in_app
  email
  push
  sms
}

enum AuditAction {
  INSERT
  UPDATE
  DELETE
}
